<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Atualizador Jade DIY - Secure Boot V1 (Vers√£o Avan√ßada)</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: #f4f7f6; 
            color: #333; 
        }
        .container { 
            max-width: 950px; 
            margin: auto; 
            background-color: #fff; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); 
        }
        .header { margin-bottom: 25px; }
        .header img { width: 70px; height: 70px; margin-bottom: 10px; }
        .controls { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; 
            margin-bottom: 25px; 
            align-items: end;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        select, button { 
            padding: 12px 16px; 
            border-radius: 8px; 
            border: 1px solid #ccc; 
            font-size: 1em; 
            background-color: #f9f9f9; 
            cursor: pointer; 
            width: 100%;
            max-width: 200px;
        }
        button { 
            background-color: #007bff; 
            color: white; 
            border-color: #007bff; 
            font-weight: 500;
        }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        
        .flash-mode-selector {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .flash-mode-selector h4 {
            margin-top: 0;
            color: #495057;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .radio-option:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .radio-option input[type="radio"]:checked + label {
            color: #007bff;
            font-weight: 500;
        }
        .radio-option.selected {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        
        .firmware-info {
            background-color: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            border-radius: 0 8px 8px 0;
            display: none;
        }
        .firmware-info.show { display: block; }
        
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: left;
        }
        .warning-box h3 { margin-top: 0; color: #856404; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-disconnected { background-color: #dc3545; }
        .status-connected { background-color: #28a745; }
        .status-programming { background-color: #ffc107; }
        
        #log-container { 
            margin-top: 20px; 
            text-align: left; 
            background-color: #1e1e1e; 
            color: #d4d4d4; 
            padding: 15px; 
            border-radius: 8px; 
            height: 350px; 
            overflow-y: auto; 
            font-family: "SF Mono", "Monaco", "Cascadia Code", "Roboto Mono", Courier, monospace; 
            font-size: 13px;
            line-height: 1.4;
        }
        .log-timestamp { color: #888; }
        .log-info { color: #569cd6; }
        .log-warning { color: #dcdcaa; }
        .log-error { color: #f44747; }
        .log-success { color: #4ec9b0; }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .version-history {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }
        .version-item {
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .version-item:last-child {
            border-bottom: none;
        }
        .version-badge {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 10px;
        }
        .version-badge.beta { background-color: #ffc107; color: #000; }
        .version-badge.stable { background-color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="assets/jade_emblem_on_dark_rgb.png" alt="Logo Jade">
            <h1>üîí Atualizador Jade DIY Avan√ßado</h1>
            <p>Para dispositivos com <strong>Secure Boot V1</strong> j√° ativado.</p>
        </div>

        <div class="warning-box">
            <h3>‚ö†Ô∏è Importante - Secure Boot V1</h3>
            <ul>
                <li><strong>Apenas atualiza√ß√£o:</strong> Para dispositivos QUE J√Å POSSUEM Secure Boot ativo</li>
                <li><strong>Firmware assinado:</strong> Use apenas firmwares assinados com SUA chave</li>
                <li><strong>Teste primeiro:</strong> Sempre teste em dispositivo de desenvolvimento</li>
                <li><strong>Modo seguro:</strong> Escolha o tipo de atualiza√ß√£o adequado abaixo</li>
            </ul>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="device-select">Dispositivo:</label>
                <select id="device-select">
                    <option value="">-- Selecione --</option>
                    <option value="tdisplay">LILYGO TTGO T-Display</option>
                </select>
            </div>
            <div class="control-group">
                <label for="firmware-select">Vers√£o de Firmware:</label>
                <select id="firmware-select" disabled>
                    <option value="">-- Selecione --</option>
                </select>
            </div>
            <div class="control-group">
                <button id="connectButton">
                    <span class="status-indicator status-disconnected"></span>
                    Conectar
                </button>
            </div>
            <div class="control-group">
                <button id="programButton" disabled>
                    üì• Atualizar Firmware
                </button>
            </div>
        </div>

        <div class="firmware-info" id="firmwareInfo">
            <h4>‚ÑπÔ∏è Informa√ß√µes da Vers√£o</h4>
            <div id="firmwareDetails"></div>
        </div>

        <div class="flash-mode-selector">
            <h4>üîß Modo de Atualiza√ß√£o</h4>
            <div class="radio-group">
                <div class="radio-option" id="conservativeMode">
                    <input type="radio" id="conservative" name="flashMode" value="conservative" checked>
                    <label for="conservative">
                        <strong>üõ°Ô∏è Conservador</strong><br>
                        <small>Apenas firmware principal</small>
                    </label>
                </div>
                <div class="radio-option" id="standardMode">
                    <input type="radio" id="standard" name="flashMode" value="standard">
                    <label for="standard">
                        <strong>‚öñÔ∏è Padr√£o</strong><br>
                        <small>Firmware + parti√ß√µes</small>
                    </label>
                </div>
                <div class="radio-option" id="fullMode">
                    <input type="radio" id="full" name="flashMode" value="full">
                    <label for="full">
                        <strong>üîÑ Completo</strong><br>
                        <small>Todos os componentes</small>
                    </label>
                </div>
            </div>
        </div>

        <div class="version-history">
            <h4>üìú Hist√≥rico de Vers√µes Dispon√≠veis</h4>
            <div id="versionHistory"></div>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div id="log-container">
            <div class="log-info">üöÄ Atualizador Jade DIY Avan√ßado v2.0</div>
            <div class="log-info">üîí Modo Secure Boot V1 com op√ß√µes de atualiza√ß√£o flex√≠veis</div>
            <div class="log-info">üí° Selecione dispositivo, vers√£o e modo de atualiza√ß√£o</div>
        </div>
    </div>

    <script type="module">
        import { ESPLoader } from "https://cdn.jsdelivr.net/npm/esptool-js@0.4.6/bundle.js";

        // Elementos da UI
        const deviceSelect = document.getElementById('device-select');
        const firmwareSelect = document.getElementById('firmware-select');
        const connectButton = document.getElementById('connectButton');
        const programButton = document.getElementById('programButton');
        const logContainer = document.getElementById('log-container');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const statusIndicator = connectButton.querySelector('.status-indicator');
        const firmwareInfo = document.getElementById('firmwareInfo');
        const firmwareDetails = document.getElementById('firmwareDetails');
        const versionHistory = document.getElementById('versionHistory');

        let esploader = null;
        let port = null;
        let isConnected = false;
        let selectedFlashMode = 'conservative';

        // Configura√ß√£o de firmwares com suporte a hist√≥rico
        const firmwares = {
            tdisplay: [
                { 
                    version: '1.0.35-v1-sb',
                    type: 'stable',
                    description: 'Vers√£o est√°vel 1.0.35 - Secure Boot V1',
                    releaseDate: '2024-01-15',
                    changelog: ['Corre√ß√µes de seguran√ßa', 'Melhorias na interface', 'Otimiza√ß√µes de performance'],
                    files: {
                        conservative: [
                            { path: 'firmware/tdisplay/1.0.35-v1-sb/jade.bin', offset: 0x10000, description: 'Firmware principal' },
                        ],
                        standard: [
                            { path: 'firmware/tdisplay/1.0.35-v1-sb/partition-table.bin', offset: 0x9000, description: 'Tabela de parti√ß√µes' },
                            { path: 'firmware/tdisplay/1.0.35-v1-sb/ota_data_initial.bin', offset: 0xE000, description: 'Dados OTA' },
                            { path: 'firmware/tdisplay/1.0.35-v1-sb/jade.bin', offset: 0x10000, description: 'Firmware principal' },
                        ],
                        full: [
                            { path: 'firmware/tdisplay/1.0.35-v1-sb/bootloader.bin', offset: 0x1000, description: 'Bootloader (RISCO!)' },
                            { path: 'firmware/tdisplay/1.0.35-v1-sb/partition-table.bin', offset: 0x9000, description: 'Tabela de parti√ß√µes' },
                            { path: 'firmware/tdisplay/1.0.35-v1-sb/ota_data_initial.bin', offset: 0xE000, description: 'Dados OTA' },
                            { path: 'firmware/tdisplay/1.0.35-v1-sb/jade.bin', offset: 0x10000, description: 'Firmware principal' },
                        ]
                    }
                }
                // Para adicionar novas vers√µes, simplesmente adicione objetos aqui seguindo a mesma estrutura
            ]
        };

        function logMessage(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="log-${type}">${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Atualizar hist√≥rico de vers√µes
        function updateVersionHistory(deviceKey) {
            if (!deviceKey || !firmwares[deviceKey]) {
                versionHistory.innerHTML = '<p>Selecione um dispositivo para ver o hist√≥rico</p>';
                return;
            }

            let historyHTML = '';
            firmwares[deviceKey].forEach((fw, index) => {
                const badgeClass = fw.type === 'stable' ? 'stable' : fw.type === 'beta' ? 'beta' : '';
                historyHTML += `
                    <div class="version-item">
                        <span class="version-badge ${badgeClass}">${fw.type.toUpperCase()}</span>
                        <strong>${fw.version}</strong> - ${fw.releaseDate}
                        <br><small>${fw.description}</small>
                        <br><small><strong>Mudan√ßas:</strong> ${fw.changelog.join(', ')}</small>
                    </div>
                `;
            });
            versionHistory.innerHTML = historyHTML;
        }

        // Event Listeners
        deviceSelect.addEventListener('change', () => {
            const selectedDevice = deviceSelect.value;
            firmwareSelect.innerHTML = '<option value="">-- Selecione --</option>';
            firmwareSelect.disabled = true;
            firmwareInfo.classList.remove('show');
            updateProgramButton();
            
            if (selectedDevice && firmwares[selectedDevice]) {
                // Ordenar por data (mais recente primeiro)
                const sortedFirmwares = [...firmwares[selectedDevice]].sort((a, b) => 
                    new Date(b.releaseDate) - new Date(a.releaseDate)
                );
                
                sortedFirmwares.forEach((fw, index) => {
                    const originalIndex = firmwares[selectedDevice].indexOf(fw);
                    const option = document.createElement('option');
                    option.value = originalIndex;
                    const badge = fw.type === 'stable' ? '‚úÖ' : fw.type === 'beta' ? 'üß™' : '‚ö†Ô∏è';
                    option.textContent = `${badge} ${fw.version} (${fw.type})`;
                    firmwareSelect.appendChild(option);
                });
                
                firmwareSelect.disabled = false;
                updateVersionHistory(selectedDevice);
                logMessage('info', `üì± Dispositivo selecionado: ${selectedDevice}`);
            } else {
                updateVersionHistory(null);
            }
        });

        firmwareSelect.addEventListener('change', () => {
            updateProgramButton();
            if (firmwareSelect.value !== "") {
                const fw = firmwares[deviceSelect.value][parseInt(firmwareSelect.value)];
                showFirmwareInfo(fw);
                logMessage('info', `üì¶ Firmware selecionado: ${fw.version} (${fw.type})`);
            } else {
                firmwareInfo.classList.remove('show');
            }
        });

        function showFirmwareInfo(firmware) {
            const filesCount = firmware.files[selectedFlashMode].length;
            const modeDescription = {
                conservative: 'Apenas o firmware principal ser√° atualizado. M√°xima seguran√ßa.',
                standard: 'Firmware + parti√ß√µes ser√£o atualizados. Recomendado para a maioria dos casos.',
                full: 'TODOS os componentes, incluindo bootloader. ALTO RISCO de brick!'
            };
            
            firmwareDetails.innerHTML = `
                <p><strong>Vers√£o:</strong> ${firmware.version} (${firmware.type})</p>
                <p><strong>Descri√ß√£o:</strong> ${firmware.description}</p>
                <p><strong>Data de Lan√ßamento:</strong> ${firmware.releaseDate}</p>
                <p><strong>Modo Selecionado:</strong> ${selectedFlashMode.toUpperCase()}</p>
                <p><strong>Arquivos a Instalar:</strong> ${filesCount}</p>
                <p><strong>Detalhes do Modo:</strong> ${modeDescription[selectedFlashMode]}</p>
                <div style="margin-top: 10px;">
                    <strong>Changelog:</strong>
                    <ul>
                        ${firmware.changelog.map(change => `<li>${change}</li>`).join('')}
                    </ul>
                </div>
            `;
            firmwareInfo.classList.add('show');
        }

        // Flash mode selection
        document.querySelectorAll('input[name="flashMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedFlashMode = e.target.value;
                
                // Update visual selection
                document.querySelectorAll('.radio-option').forEach(option => {
                    option.classList.remove('selected');
                });
                e.target.closest('.radio-option').classList.add('selected');
                
                // Update firmware info if firmware is selected
                if (firmwareSelect.value !== "") {
                    const fw = firmwares[deviceSelect.value][parseInt(firmwareSelect.value)];
                    showFirmwareInfo(fw);
                }
                
                logMessage('info', `üîß Modo de atualiza√ß√£o: ${selectedFlashMode.toUpperCase()}`);
            });
        });

        // Initialize flash mode
        document.getElementById('conservativeMode').classList.add('selected');

        function updateProgramButton() {
            programButton.disabled = !isConnected || !deviceSelect.value || !firmwareSelect.value;
        }

        // Conex√£o (mesmo c√≥digo anterior, simplificado aqui)
        connectButton.addEventListener('click', async () => {
            if (!isConnected) {
                await connectDevice();
            } else {
                await disconnectDevice();
            }
        });

        async function connectDevice() {
            try {
                logMessage('info', 'üîå Solicitando conex√£o...');
                
                if (!navigator.serial) {
                    throw new Error('Web Serial API n√£o suportada. Use Chrome/Edge.');
                }

                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                esploader = new ESPLoader(port, { logger: console });
                await esploader.connect();
                
                const chipInfo = await esploader.chipName();
                const macAddr = await esploader.readMac();
                
                logMessage('success', `‚úÖ Conectado: ${chipInfo}`);
                logMessage('info', `üìç MAC: ${macAddr}`);
                
                isConnected = true;
                connectButton.innerHTML = '<span class="status-indicator status-connected"></span>Desconectar';
                statusIndicator.className = 'status-indicator status-connected';
                updateProgramButton();
                
            } catch (error) {
                logMessage('error', `‚ùå Erro: ${error.message}`);
                await disconnectDevice();
            }
        }

        async function disconnectDevice() {
            try {
                if (esploader) {
                    await esploader.disconnect();
                    esploader = null;
                }
                if (port) {
                    await port.close();
                    port = null;
                }
                isConnected = false;
                connectButton.innerHTML = '<span class="status-indicator status-disconnected"></span>Conectar';
                statusIndicator.className = 'status-indicator status-disconnected';
                updateProgramButton();
                logMessage('info', 'üîå Desconectado');
            } catch (error) {
                logMessage('warning', `‚ö†Ô∏è Erro ao desconectar: ${error.message}`);
            }
        }

        // Programa√ß√£o
        programButton.addEventListener('click', async () => {
            await programFirmware();
        });

        async function programFirmware() {
            const deviceKey = deviceSelect.value;
            const firmwareIndex = parseInt(firmwareSelect.value);

            if (!deviceKey || isNaN(firmwareIndex)) {
                logMessage('error', '‚ùå Selecione dispositivo e firmware');
                return;
            }

            const firmware = firmwares[deviceKey][firmwareIndex];
            const filesToFlash = firmware.files[selectedFlashMode];
            
            programButton.disabled = true;
            statusIndicator.className = 'status-indicator status-programming';
            progressBar.style.display = 'block';

            try {
                logMessage('info', `üöÄ Iniciando: ${firmware.version} (${selectedFlashMode})`);
                
                if (selectedFlashMode === 'full') {
                    logMessage('warning', '‚ö†Ô∏è MODO COMPLETO: Incluindo bootloader - RISCO DE BRICK!');
                } else if (selectedFlashMode === 'conservative') {
                    logMessage('success', 'üõ°Ô∏è MODO CONSERVATIVO: Apenas firmware - M√°xima seguran√ßa');
                }

                // Baixar arquivos
                const flashData = [];
                for (let i = 0; i < filesToFlash.length; i++) {
                    const file = filesToFlash[i];
                    logMessage('info', `üì• Baixando: ${file.description}`);
                    
                    try {
                        const response = await fetch(file.path);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = new Uint8Array(await response.arrayBuffer());
                        flashData.push({
                            data: data,
                            address: file.offset
                        });
                        
                        updateProgress((i + 1) / filesToFlash.length * 30);
                        
                    } catch (error) {
                        throw new Error(`Erro ao baixar ${file.description}: ${error.message}`);
                    }
                }

                logMessage('success', '‚úÖ Arquivos baixados');
                logMessage('info', 'üíæ Gravando na flash...');

                const flashOptions = {
                    fileArray: flashData,
                    flashSize: 'keep',
                    flashMode: selectedFlashMode === 'full' ? 'dio' : 'keep',
                    flashFreq: selectedFlashMode === 'full' ? '40m' : 'keep',
                    eraseAll: false,
                    compress: true,
                    progressCallback: (bytesWritten, totalBytes) => {
                        const progress = 30 + (bytesWritten / totalBytes) * 60;
                        updateProgress(progress);
                    }
                };

                await esploader.writeFlash(flashOptions);
                updateProgress(95);

                logMessage('success', '‚úÖ Firmware gravado!');
                logMessage('info', 'üîÑ Reiniciando...');
                
                await esploader.hardReset();
                updateProgress(100);
                
                logMessage('success', 'üéâ Atualiza√ß√£o conclu√≠da!');
                logMessage('info', `üîí Dispositivo atualizado para ${firmware.version}`);

            } catch (error) {
                logMessage('error', `‚ùå Falha: ${error.message}`);
            } finally {
                programButton.disabled = false;
                statusIndicator.className = 'status-indicator status-connected';
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    updateProgress(0);
                }, 3000);
                updateProgramButton();
            }
        }

        function updateProgress(percent) {
            progressFill.style.width = `${Math.min(100, Math.max(0, percent))}%`;
        }

        // Inicializa√ß√£o
        logMessage('info', 'üéØ Sistema pronto. Selecione dispositivo e modo de atualiza√ß√£o.');
        updateVersionHistory(null);
        
    </script>
</body>
</html>